# SliTaz package receipt.

PACKAGE="openerp-server"
VERSION="6.1-1"
CATEGORY="office"
SHORT_DESC="Open source ERP server & web server files."
MAINTAINER="pascal.bellard@slitaz.org"
SOURCE="openerp"
TARBALL="$SOURCE-$VERSION.tar.gz"
WEB_SITE="http://openerp.com/"
WGET_URL="http://nightly.openerp.com/${VERSION%[-r]*}/release/$TARBALL"

DEPENDS="python python-simplejson psycopg2 python-lxml python-pyyaml \
python-reportlab python-mako python-markupsafe python-pychart \
python-pil python-werkzeug python-dateutil python-babel postgresql \
python-ldap ghostscript feedparser matplotlib \
python-pydot python-pygraphviz python-pyparsing python-pytz \
python-gdata python-openid python-vatnumber python-webdav \
python-vobject python-zsi python-xlwt libxslt-python pyopenssl \
python27-mysql python27-caldav"
BUILD_DEPENDS="slitaz-toolchain python python-dev rsync setuptools \
python-babel"

# Rules to configure and make the package.
compile_rules()
{
	mv $SOURCE-$VERSION-* $src 2> /dev/null
	cd $src
	python setup.py install --root=$DESTDIR
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/var/run/openerp $fs/var/log/openerp
	mkdir -p $fs/etc/logrotate.d $fs/etc/openerp
	mkdir -p $fs/usr/share/applications
	chmod 777 $fs/var/run/openerp $fs/var/log/openerp
	cp -a $_pkg/usr/lib $_pkg/usr/bin $fs/usr
	cp -a $_pkg/usr/openerp $fs/usr/lib/python*/site-packages
	cp $src/install/openerp-server.logrotate $fs/etc/logrotate.d
	cp $src/install/openerp-server.conf $fs/etc/openerp
	cp -a stuff/* $fs
}

# Pre and post install commands for Tazpkg.
post_install()
{
	chroot $1/ adduser -H -D -S -s /bin/sh -h /tmp -g "OpenERP Daemon user" openerp
        chown openerp:openerp $1/etc/openerp/openerp-server.conf
        chmod 0640 $1/etc/openerp/openerp-server.conf
        touch $1/var/log/openerp-server.log
        chown -R openerp $1/var/log/openerp
        chmod 0640 $1/var/log/openerp-server.log
        mkdir -p $1/var/lib/openerp/filestore
        chown openerp -R $1/var/lib/openerp
	if [ -z "$1" ]; then
		/etc/init.d/postgresql stop
		/etc/init.d/postgresql start
		/etc/init.d/openerp-server start
	fi
	cat <<EOF
----
To start $SOURCE server you can run :

    /etc/init.d/openerp-server start

Or add $SOURCE to RUN_DAEMONS in /etc/rcS.conf
----
EOF
}
