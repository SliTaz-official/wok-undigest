# SliTaz package receipt.

PACKAGE="palemoon"
VERSION="26.2.2"
CATEGORY="network"
LICENSE="MPL2"
SHORT_DESC="Browser based on Firefox that's optimised for performance"
WEB_SITE="http://palemoon.org"
MAINTAINER="psychomaniak@xakep.ru"
TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="https://github.com/MoonchildProductions/Pale-Moon/archive/${VERSION}_Release.tar.gz"

DEPENDS="gtk+ "

BUILD_DEPENDS="autoconf213 gtk+-dev yasm zip unzip iw dbus-dev dbus-glib-dev \
iw libpng-dev gstreamer gstreamer-dev gst-plugins-base-dev gst-plugins-base \
libvpx-dev mesa-dev setuptools virtualenv zlib-dev bzip2-dev python-dev \
pixman pixman-dev sqlite sqlite-dev libffi libffi-dev libevent libevent-dev"

# Rules to configure and make the package.
compile_rules()
{
	find -type f | grep duckduckgo | xargs \
		sed -i 's|name="t" value="palemoon"|name="t" value="slitaz"|'
	cat > mozconfig <<EOT
export MOZILLA_OFFICIAL=1
mk_add_options MOZ_CO_PROJECT=browser
mk_add_options MOZ_MAKE_FLAGS="-j4"
ac_add_options --enable-official-branding
ac_add_options --enable-application=browser
ac_add_options --disable-tests
ac_add_options --disable-mochitests
ac_add_options --disable-debug
ac_add_options --disable-pulseaudio
ac_add_options --with-pthreads
ac_add_options --enable-shared-js
ac_add_options --enable-jemalloc
ac_add_options --enable-jemalloc-lib
ac_add_options --enable-gstreamer=0.10
ac_add_options --enable-optimize="-mtune=i686"
ac_add_options --enable-strip
ac_add_options --x-libraries=/usr/lib
ac_add_options --prefix=/usr
ac_add_options --disable-b2g-bt
ac_add_options --disable-b2g-camera
ac_add_options --disable-b2g-ril
ac_add_options --disable-accessibility
ac_add_options --disable-codesighs
ac_add_options --disable-crashreporter
ac_add_options --disable-gamepad
ac_add_options --disable-installer
ac_add_options --disable-logging
ac_add_options --disable-mobile-optimize
ac_add_options --disable-metro
ac_add_options --disable-maintenance-service
ac_add_options --disable-necko-wifi
ac_add_options --disable-parental-controls
ac_add_options --disable-updater
ac_add_options --disable-webrtc
ac_add_options --disable-websms-backend
ac_add_options --disable-windows-mobile-components
ac_add_options --disable-valgrind

ac_add_options --disable-ogg
ac_add_options --disable-webm
ac_add_options --disable-webgl
#ac_add_options --with-system-libvpx
ac_add_options --with-system-libevent
ac_add_options --with-system-zlib
ac_add_options --with-system-bz2
# ac_add_options --enable-system-sqlite
# ac_add_options --enable-system-ffi
ac_add_options --enable-system-pixman
EOT
	chmod -R +x build/autoconf/* python/*                                                               
	find . -name '*.sh' -exec chmod +x {} \;
	export MOZBUILD_STATE_PATH="$src/mozbuild"
	export MOZCONFIG="$src/mozconfig"
	export CPPFLAGS="$CPPFLAGS -O2 -std=gnu++0x"
	python2 mach configure
	python2 mach build || echo "Next =>"
	python2 mach build
	cd $src/obj-i686-pc-linux-gnu
	(make package) > ./instLOG 2>&1
	cd dist
	install -d "$DESTDIR"/usr/bin
	install -d "$DESTDIR"/usr/lib
	cp -a palemoon $DESTDIR/usr/lib/$PACKAGE
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	cp -a $install/* $fs
}
